jobs:
    - job:
      displayName: ubuntu-latest
      pool:
        vmImage: 'ubuntu-latest'

      steps:
      - bash: echo "##vso[task.prependpath]$CONDA/bin"
        displayName: Add conda to PATH

      - bash: |
          wget https://raw.githubusercontent.com/qiime2/environment-files/master/2020.2/release/qiime2-2020.2-py36-linux-conda.yml
          conda env create -q -n qiime2-dev --file qiime2-latest-py36-linux-conda.yml
        displayName: Set up Qiime 2

      - bash: |
          source activate qiime2-dev
          conda install --yes --quiet --name qiime2-dev -c conda-forge -c bioconda cobra umap-learn jinja2 loky pyarrow flake8 loguru tqdm
        displayName: Install required packages
      - bash: |
          source activate qiime2-dev
          conda install --yes --quiet --name qiime2-dev -c ibmdecisionoptimization cplex
        displayName: Install CPLEX test distribution
      - bash: |
          source activate qiime2-dev
          pip install .
          qiime dev refresh-cache
        displayName: Install q2-micom
      - bash: |
          source activate qiime2-dev
          pip install pytest pytest-azurepipelines
          pytest
        displayName: Run tests
      - script: |
          source activate qiime2-dev
          pip uninstall -y pytest-azurepipelines
          pip install pytest-cov
          pytest --cov
          bash <(curl -s https://codecov.io/bash)
        displayName: "Upload to codecov.io"


    - job:
      displayName: macOS-latest
      pool:
        vmImage: 'macOS-latest'

      steps:
      - bash: echo "##vso[task.prependpath]$CONDA/bin"
        displayName: Add conda to PATH

      - bash: sudo chown -R $USER $CONDA
        displayName: Take ownership of conda installation

      - bash: |
          wget https://raw.githubusercontent.com/qiime2/environment-files/master/2020.2/release/qiime2-2020.2-py36-osx-conda.yml
          conda env create -q -n qiime2-dev --file qiime2-latest-py36-osx-conda.yml
        displayName: Set up Qiime 2

      - bash: |
          source activate qiime2-dev
          conda install --yes --quiet --name qiime2-dev -c conda-forge -c bioconda cobra umap-learn jinja2 loky pyarrow flake8 loguru tqdm
        displayName: Install required packages
      - bash: |
          source activate qiime2-dev
          conda install --yes --quiet --name qiime2-dev -c ibmdecisionoptimization cplex
        displayName: Install CPLEX test distribution
      - bash: |
          source activate qiime2-dev
          pip install .
          qiime dev refresh-cache
        displayName: Install q2-micom
      - bash: |
          source activate qiime2-dev
          flake8
        displayName: "Run flake8"
      - bash: |
          source activate qiime2-dev
          pip install pytest pytest-cov pytest-azurepipelines
          pytest
        displayName: Run tests
